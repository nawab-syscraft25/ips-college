{% extends "base.html" %}

{% block content %}
<style>
  .seo-container {
    max-width: 900px;
  }
  
  .seo-card {
    background: white;
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .seo-card-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e5e7eb;
  }
  
  .seo-card-header i {
    font-size: 1.5rem;
    color: var(--primary);
  }
  
  .seo-card-header h3 {
    margin: 0;
    color: var(--dark);
    font-size: 1.125rem;
  }
  
  .form-group {
    margin-bottom: 1.5rem;
  }
  
  .form-label {
    display: block;
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }
  
  .form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-family: inherit;
  }
  
  .form-control:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }
  
  textarea.form-control {
    resize: vertical;
    min-height: 100px;
  }
  
  .hint-text {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.25rem;
  }
  
  .seo-score {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .score-box {
    text-align: center;
    padding: 1rem;
    background: var(--light);
    border-radius: 0.5rem;
    border: 2px solid #e5e7eb;
  }
  
  .score-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary);
    margin: 0.5rem 0;
  }
  
  .score-label {
    font-size: 0.75rem;
    color: #6b7280;
    text-transform: uppercase;
    font-weight: 600;
  }
  
  .preview-box {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
  }
  
  .preview-title {
    color: var(--primary);
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
    word-break: break-all;
  }
  
  .preview-url {
    color: #065f46;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
  }
  
  .preview-description {
    color: #6b7280;
    font-size: 0.875rem;
    line-height: 1.5;
  }
  
  .keyword-tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  .keyword-tag {
    background: #dbeafe;
    color: var(--primary);
    padding: 0.375rem 0.75rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .keyword-tag button {
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    font-weight: bold;
    padding: 0;
  }
  
  .checklist-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: var(--light);
    border-radius: 0.375rem;
  }
  
  .checklist-item.done {
    background: #dcfce7;
  }
  
  .checklist-icon {
    flex-shrink: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    color: white;
    font-size: 0.75rem;
    margin-top: 0.125rem;
  }
  
  .checklist-item.done .checklist-icon {
    background: var(--success);
  }
  
  .checklist-item:not(.done) .checklist-icon {
    background: #fbbf24;
  }
  
  .action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: space-between;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 2px solid #e5e7eb;
  }
  
  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 0.5rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
  }
  
  .btn-primary {
    background: var(--primary);
    color: white;
  }
  
  .btn-primary:hover {
    background: var(--primary-dark);
  }
  
  .btn-secondary {
    background: white;
    border: 1px solid #e5e7eb;
    color: var(--dark);
  }
  
  .btn-secondary:hover {
    background: var(--light);
  }
</style>

<div class="seo-container">
  <!-- SEO Scores -->

  <!-- Meta Information -->
  <div class="seo-card">
    <div class="seo-card-header">
      <i class="fas fa-file-alt"></i>
      <h3>Meta Information</h3>
    </div>
    
    <form id="seoForm">
      <!-- Meta Title -->
      <div class="form-group">
        <label class="form-label">Meta Title (Title Tag) *</label>
        <input type="text" class="form-control" id="metaTitle" maxlength="60" 
               value="{{ (page.seo.meta_title or page.title or '')|default('', true) if page else '' }}"
               placeholder="Keep it under 60 characters">
        <div class="hint-text">
          <span id="titleCount">{{ (page.seo.meta_title or '')|length if page and page.seo else 0 }}</span>/60 characters
          <span id="titleStatus" style="margin-left: 1rem; color: #6b7280;">Good length</span>
        </div>
      </div>

      <!-- Meta Description -->
      <div class="form-group">
        <label class="form-label">Meta Description *</label>
        <textarea class="form-control" id="metaDescription" maxlength="160" 
                  placeholder="Describe your page in 150-160 characters">{{ (page.seo.meta_description or '')|default('', true) if page and page.seo else '' }}</textarea>
        <div class="hint-text">
          <span id="descCount">{{ (page.seo.meta_description or '')|length if page and page.seo else 0 }}</span>/160 characters
          <span id="descStatus" style="margin-left: 1rem; color: #6b7280;">Good length</span>
        </div>
      </div>

      <!-- Focus Keyword -->
      <div class="form-group">
        <label class="form-label">Focus Keyword *</label>
        <input type="text" class="form-control" id="focusKeyword" 
               value="{{ (page.seo.focus_keyword or '')|default('', true) if page and page.seo else '' }}"
               placeholder="e.g., best engineering college in Delhi">
        <div class="hint-text">Enter 1-3 words you want to rank for</div>
      </div>

      <!-- Keywords -->
      <div class="form-group">
        <label class="form-label">Keywords (Tags)</label>
        <input type="text" class="form-control" id="keywordsInput" 
               placeholder="Type and press Enter to add keywords">
        <div class="keyword-tags" id="keywordsList" style="margin-top: 1rem;">
          {% if page and page.seo and page.seo.meta_keywords %}
            {% for keyword in page.seo.meta_keywords.split(',') %}
            <div class="keyword-tag">
              {{ keyword.strip() }}
              <button type="button" onclick="removeKeyword(this)">×</button>
            </div>
            {% endfor %}
          {% endif %}
        </div>
      </div>

      <!-- URL Slug -->
      <div class="form-group">
        <label class="form-label">Page URL Slug</label>
        <input type="text" class="form-control" id="urlSlug" 
               value="{{ (page.slug or '')|default('', true) if page else '' }}"
               placeholder="auto-generated-page-slug">
        <div class="hint-text">Automatically generated from title</div>
      </div>

      <!-- Canonical URL -->
      <div class="form-group">
        <label class="form-label">Canonical URL</label>
        <input type="url" class="form-control" id="canonicalUrl" 
               value="{{ (page.seo.canonical_url or '')|default('', true) if page and page.seo else '' }}"
               placeholder="https://yourdomain.com/page">
        <div class="hint-text">Leave blank to auto-generate</div>
      </div>

      <!-- Open Graph -->
      <div style="padding-top: 1rem; border-top: 1px solid #e5e7eb;">
        <h4 style="font-weight: 600; color: var(--dark); margin-bottom: 1rem;">Social Media (Open Graph)</h4>
        
        <div class="form-group">
          <label class="form-label">OG Title</label>
          <input type="text" class="form-control" id="ogTitle" maxlength="50"
                 value="{{ (page.seo.og_title or '')|default('', true) if page and page.seo else '' }}"
                 placeholder="Title for social sharing">
        </div>

        <div class="form-group">
          <label class="form-label">OG Description</label>
          <textarea class="form-control" id="ogDescription" maxlength="160"
                    placeholder="Description for social sharing">{{ (page.seo.og_description or '')|default('', true) if page and page.seo else '' }}</textarea>
        </div>

        <div class="form-group">
          <label class="form-label">OG Image URL</label>
          <input type="url" class="form-control" id="ogImage" 
                 value="{{ (page.seo.og_image or '')|default('', true) if page and page.seo else '' }}"
                 placeholder="https://yourdomain.com/image.jpg">
        </div>
      </div>

      <!-- Schema JSON -->
      <div style="padding-top: 1rem; border-top: 1px solid #e5e7eb;">
        <h4 style="font-weight: 600; color: var(--dark); margin-bottom: 1rem;">Schema Markup (JSON-LD)</h4>
        
        <div class="form-group">
          <label class="form-label">Schema JSON</label>
          <textarea class="form-control" id="schemaJson" style="font-family: monospace; font-size: 0.85rem;" placeholder="{&#10;  \"@context\": \"https://schema.org\",&#10;  \"@type\": \"Organization\"&#10;}">{{ (page.seo.schema_json|tojson if page.seo.schema_json else '')|default('', true) if page and page.seo else '' }}</textarea>
          <div class="hint-text">Optional JSON-LD schema markup for rich snippets in search results</div>
        </div>
      </div>
    </form>
  </div>

  <!-- Preview -->
  <div class="seo-card">
    <div class="seo-card-header">
      <i class="fas fa-eye"></i>
      <h3>Search Preview</h3>
    </div>
    
    <div class="preview-box">
      <div class="preview-title" id="previewTitle">{{ (page.seo.meta_title or page.title or 'Your Page Title')|default('Your Page Title', true) if page else 'Your Page Title' }}</div>
      <div class="preview-url">{{ domain if domain else 'ipsacademy.edu.in' }}/{{ (page.slug or 'your-page')|default('your-page', true) if page else 'your-page' }}</div>
      <div class="preview-description" id="previewDesc">{{ (page.seo.meta_description or 'Your meta description appears here')|default('Your meta description appears here', true) if page and page.seo else 'Your meta description appears here' }}</div>
    </div>
  </div>

  <!-- SEO Checklist -->
  <div class="seo-card">
    <div class="seo-card-header">
      <i class="fas fa-check-circle"></i>
      <h3>SEO Checklist</h3>
    </div>
    
    <div id="seoChecklist">
      <div class="checklist-item" id="check-title">
        <div class="checklist-icon">!</div>
        <div>
          <strong>Meta Title Set</strong>
          <div style="font-size: 0.75rem; color: #6b7280;">Add a title to appear in search results</div>
        </div>
      </div>
      
      <div class="checklist-item" id="check-description">
        <div class="checklist-icon">!</div>
        <div>
          <strong>Meta Description Set</strong>
          <div style="font-size: 0.75rem; color: #6b7280;">Add a description (150-160 chars)</div>
        </div>
      </div>
      
      <div class="checklist-item" id="check-keyword">
        <div class="checklist-icon">!</div>
        <div>
          <strong>Focus Keyword Added</strong>
          <div style="font-size: 0.75rem; color: #6b7280;">Set a focus keyword for this page</div>
        </div>
      </div>
      
      <div class="checklist-item done" id="check-mobile">
        <div class="checklist-icon">✓</div>
        <div>
          <strong>Mobile Optimized</strong>
          <div style="font-size: 0.75rem; color: #6b7280;">This page is mobile-friendly</div>
        </div>
      </div>
      
      <div class="checklist-item" id="check-speed">
        <div class="checklist-icon">!</div>
        <div>
          <strong>Page Speed Good</strong>
          <div style="font-size: 0.75rem; color: #6b7280;">Check Core Web Vitals performance</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons">
    <a href="/admin/pages?college_id={{ selected_college_id }}" class="btn btn-secondary">
      <i class="fas fa-arrow-left"></i> Back to Pages
    </a>
    <button class="btn btn-primary" id="saveSEOBtn" type="button">
      <i class="fas fa-save"></i> Save SEO Settings
    </button>
  </div>
</div>
<script>
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    initializeChecklist();
    updatePreview();
    document.getElementById('saveSEOBtn')?.addEventListener('click', saveSEO);
  });

  // Character counters
  document.getElementById('metaTitle')?.addEventListener('input', function() {
    document.getElementById('titleCount').textContent = this.value.length;
    const status = this.value.length === 0 ? 'Enter title' : 
                   this.value.length < 30 ? 'Too short' : 
                   this.value.length > 60 ? 'Too long' : 'Good length';
    document.getElementById('titleStatus').textContent = status;
    document.getElementById('check-title').classList.toggle('done', this.value.length > 0);
    updatePreview();
  });
  
  document.getElementById('metaDescription')?.addEventListener('input', function() {
    document.getElementById('descCount').textContent = this.value.length;
    const status = this.value.length === 0 ? 'Enter description' : 
                   this.value.length < 120 ? 'Too short' : 
                   this.value.length > 160 ? 'Too long' : 'Good length';
    document.getElementById('descStatus').textContent = status;
    document.getElementById('check-description').classList.toggle('done', this.value.length > 0);
    updatePreview();
  });
  
  document.getElementById('focusKeyword')?.addEventListener('input', function() {
    document.getElementById('check-keyword').classList.toggle('done', this.value.length > 0);
  });
  
  // Add keywords on Enter
  document.getElementById('keywordsInput')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      const keyword = this.value.trim();
      if (keyword) {
        const tag = document.createElement('div');
        tag.className = 'keyword-tag';
        tag.innerHTML = `${keyword}<button type="button" onclick="removeKeyword(this)">×</button>`;
        document.getElementById('keywordsList').appendChild(tag);
        this.value = '';
      }
    }
  });
  
  // Delete keyword by clicking outside or pressing delete
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Delete' || e.key === 'Backspace') {
      const focused = document.activeElement;
      if (focused && focused.classList.contains('keyword-tag')) {
        focused.remove();
      }
    }
  });
  
  function removeKeyword(btn) {
    btn.parentElement.remove();
  }
  
  function getKeywordsArray() {
    const keywordElements = document.querySelectorAll('.keyword-tag');
    return Array.from(keywordElements).map(el => {
      return el.textContent.replace('×', '').trim();
    });
  }
  
  function updatePreview() {
    const title = document.getElementById('metaTitle')?.value || 'Your Page Title';
    const desc = document.getElementById('metaDescription')?.value || 'Your meta description appears here';
    document.getElementById('previewTitle').textContent = title;
    document.getElementById('previewDesc').textContent = desc;
  }
  
  function initializeChecklist() {
    // Check meta title
    const titleVal = document.getElementById('metaTitle')?.value || '';
    document.getElementById('check-title').classList.toggle('done', titleVal.length > 0);
    
    // Check meta description
    const descVal = document.getElementById('metaDescription')?.value || '';
    document.getElementById('check-description').classList.toggle('done', descVal.length > 0);
    
    // Check focus keyword
    const keywordVal = document.getElementById('focusKeyword')?.value || '';
    document.getElementById('check-keyword').classList.toggle('done', keywordVal.length > 0);
    
    // Check if mobile optimized (always true)
    document.getElementById('check-mobile').classList.add('done');
    
    // Character counter initialization
    document.getElementById('titleCount').textContent = titleVal.length;
    document.getElementById('descCount').textContent = descVal.length;
  }
  
  function saveSEO(event) {
    // Validate required fields
    const metaTitle = document.getElementById('metaTitle')?.value?.trim() || '';
    const metaDesc = document.getElementById('metaDescription')?.value?.trim() || '';
    const focusKeyword = document.getElementById('focusKeyword')?.value?.trim() || '';
    
    if (!metaTitle) {
      alert('Please enter a Meta Title');
      return;
    }
    if (!metaDesc) {
      alert('Please enter a Meta Description');
      return;
    }
    if (!focusKeyword) {
      alert('Please enter a Focus Keyword');
      return;
    }
    
    const formData = new FormData();
    
    // Collect all form fields
    formData.append('meta_title', metaTitle);
    formData.append('meta_description', metaDesc);
    formData.append('focus_keyword', focusKeyword);
    
    // Collect keywords
    const keywords = getKeywordsArray();
    formData.append('meta_keywords', keywords.join(','));
    
    formData.append('canonical_url', document.getElementById('canonicalUrl')?.value || '');
    formData.append('og_title', document.getElementById('ogTitle')?.value || '');
    formData.append('og_description', document.getElementById('ogDescription')?.value || '');
    formData.append('og_image', document.getElementById('ogImage')?.value || '');
    
    // Collect schema JSON
    const schemaJson = document.getElementById('schemaJson')?.value?.trim();
    if (schemaJson) {
      try {
        // Validate JSON
        JSON.parse(schemaJson);
        formData.append('schema_json', schemaJson);
      } catch (e) {
        console.warn('Invalid JSON in schema field');
      }
    }
    
    // Get page ID from URL
    const pathParts = window.location.pathname.split('/').filter(p => p);
    const pageId = pathParts[2]; // /admin/page/{page_id}/seo
    const collegeId = new URLSearchParams(window.location.search).get('college_id') || '';
    
    if (!pageId) {
      alert('Error: Page ID not found in URL');
      return;
    }
    
    const submitBtn = event.currentTarget;
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    
    const url = `/admin/page/${pageId}/seo?college_id=${collegeId}`;
    
    fetch(url, {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.ok || response.status === 303) {
        submitBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
        setTimeout(() => {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }, 2000);
        // Refresh the page to show updated values
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else if (response.status === 400) {
        return response.json().then(data => {
          throw new Error(data.detail || 'Validation error');
        });
      } else {
        throw new Error('Save failed with status ' + response.status);
      }
    })
    .catch(error => {
      console.error('Save error:', error);
      alert('Failed to save SEO settings: ' + error.message);
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    });
  }
</script>
{% endblock %}
