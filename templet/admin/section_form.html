{% extends "base.html" %}
{% block content %}
<!-- Include Quill Rich Text Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
  .section-form {
    background: white;
    border-radius: 0.75rem;
    padding: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .form-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .form-section:last-of-type {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }
  
  .form-section-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .type-specific-fields {
    background: #f9fafb;
    border-left: 4px solid var(--primary);
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-top: 1.5rem;
  }
  
  .image-preview {
    max-width: 100%;
    max-height: 200px;
    border-radius: 0.5rem;
    margin-top: 0.5rem;
  }
  
  .btn-group-custom {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
</style>

<h1 class="mb-4">{{ 'Edit' if action == 'edit' else 'Add' }} Section ‚Äî {{ page.title }}</h1>

<form method="post" action="{% if action == 'edit' %}/admin/pages/{{ page.id }}/sections/{{ section.id }}/edit{% else %}/admin/pages/{{ page.id }}/sections/new{% endif %}" enctype="multipart/form-data" class="section-form">
  
  <!-- Basic Section Info -->
  <div class="form-section">
    <div class="form-section-title">
      <i class="fas fa-info-circle"></i> Basic Information
    </div>
    
    <div class="row">
      <div class="col-md-8">
        <div class="mb-3">
          <label class="form-label">Section Title</label>
          <input name="section_title" class="form-control" placeholder="e.g., Welcome to our campus" value="{{ section.section_title if section else '' }}">
        </div>
        <div class="mb-3">
          <label class="form-label">Section Description</label>
          <div id="section_description" style="background: white; min-height: 200px;"></div>
          <textarea name="section_description" style="display: none;">{{ section.section_description if section else '' }}</textarea>
        </div>
      </div>
      <div class="col-md-4">
        <div class="mb-3">
          <label class="form-label">Section Type</label>
          <select name="section_type" id="sectionType" class="form-select" onchange="updateTypeFields()">
            {% set current_type = section.section_type if section else 'HERO' %}
            <option value="HERO" {% if current_type == 'HERO' %}selected{% endif %}>üñºÔ∏è Hero</option>
            <option value="TEXT" {% if current_type == 'TEXT' %}selected{% endif %}>üìù Text / Content</option>
            <option value="ABOUT" {% if current_type == 'ABOUT' %}selected{% endif %}>‚ÑπÔ∏è About</option>
            <option value="STATS" {% if current_type == 'STATS' %}selected{% endif %}>üìä Statistics</option>
            <option value="INFO_BAR" {% if current_type == 'INFO_BAR' %}selected{% endif %}>üìà Stats & Accreditation Bar</option>
            <option value="CARDS" {% if current_type == 'CARDS' %}selected{% endif %}>üé¥ Cards / Grid</option>
            <option value="COURSES" {% if current_type == 'COURSES' %}selected{% endif %}>üìö Courses</option>
            <option value="FACULTY" {% if current_type == 'FACULTY' %}selected{% endif %}>üë• Faculty</option>
            <option value="FACILITIES" {% if current_type == 'FACILITIES' %}selected{% endif %}>üè¢ Facilities</option>
            <option value="PLACEMENTS" {% if current_type == 'PLACEMENTS' %}selected{% endif %}>ü§ù Placements</option>
            <option value="FAQ" {% if current_type == 'FAQ' %}selected{% endif %}>‚ùì FAQ</option>
            <option value="FORM" {% if current_type == 'FORM' %}selected{% endif %}>üìã Form</option>
            <option value="TESTIMONIALS" {% if current_type == 'TESTIMONIALS' %}selected{% endif %}>üí¨ Testimonials</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- HERO Section Specific Fields -->
  <div id="heroFields" class="form-section" style="display: none;">
    <div class="form-section-title">
      <i class="fas fa-image"></i> Hero Section Settings
    </div>

    <div class="type-specific-fields">
      <div class="mb-3">
        <label class="form-label">Upload Hero Image</label>
        <input type="file" name="hero_image" id="heroImageInput" class="form-control" accept="image/*" onchange="previewHeroImage(event)">
        <small class="form-text text-muted">Upload a hero image (JPG, PNG, WebP supported)</small>
        <input type="hidden" name="delete_hero_image" id="deleteHeroImage" value="0">
        <div id="heroImagePreview">
          {% if section and section.hero_images and section.hero_images|length > 0 %}
          <div id="currentHeroImage" style="margin-top: 1rem; position: relative; display: inline-block;">
            <small class="text-muted">Current image:</small><br>
            <div style="position: relative; display: inline-block; margin-top: 0.5rem;">
              <img src="{{ section.hero_images[0] }}" alt="Current hero image" class="image-preview" style="max-width: 300px; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
              <button type="button" onclick="deleteCurrentHeroImage()" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px; line-height: 1; box-shadow: 0 2px 4px rgba(0,0,0,0.2);" title="Delete image">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          {% elif section and section.extra_data and section.extra_data.get('images') %}
          <div id="currentHeroImage" style="margin-top: 1rem; position: relative; display: inline-block;">
            <small class="text-muted">Current image:</small><br>
            <div style="position: relative; display: inline-block; margin-top: 0.5rem;">
              <img src="{{ section.extra_data.get('images')[0] }}" alt="Current hero image" class="image-preview" style="max-width: 300px; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
              <button type="button" onclick="deleteCurrentHeroImage()" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px; line-height: 1; box-shadow: 0 2px 4px rgba(0,0,0,0.2);" title="Delete image">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Call-to-Action Text (optional)</label>
            <input name="cta_text" class="form-control" placeholder="e.g., Learn More, Apply Now" value="{{ section.extra_data.get('cta_text') if section and section.extra_data else '' }}">
            <small class="form-text text-muted">Button text for the hero section</small>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Call-to-Action Link (optional)</label>
            <input name="cta_link" class="form-control" placeholder="e.g., /admissions or https://..." value="{{ section.extra_data.get('cta_link') if section and section.extra_data else '' }}">
            <small class="form-text text-muted">Where the button should link to</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- INFO BAR Section (Stats + Accreditation) -->
  <div id="infoBarFields" class="form-section" style="display: none;">
    <div class="form-section-title">
      <i class="fas fa-award"></i> Stats & Accreditation Settings
    </div>

    <div class="type-specific-fields">
      <p class="mb-3"><strong>Note:</strong> This section displays statistics and accreditation info. Use "Manage Items" after saving to add stats and accreditation badges.</p>
      
      <div class="alert alert-info">
        <h6><i class="fas fa-info-circle"></i> Stats Items (First 5 items)</h6>
        <p class="mb-0">Add items with <strong>title</strong> (e.g., "30", "500+") and <strong>subtitle</strong> (e.g., "Years Legacy")</p>
      </div>
      
      <div class="alert alert-success">
        <h6><i class="fas fa-trophy"></i> Accreditation Items (Remaining items)</h6>
        <p class="mb-0">Add items with <strong>title</strong> (e.g., "NAAC A++"), <strong>subtitle</strong> (description), and optional <strong>image</strong></p>
      </div>
    </div>
  </div>

  <!-- Settings -->
  <div class="form-section">
    <div class="form-section-title">
      <i class="fas fa-cog"></i> Settings
    </div>
    
    <div class="row">
      <div class="col-md-4">
        <div class="mb-3">
          <label class="form-label">Sort Order</label>
          <input type="number" name="sort_order" class="form-control" value="{{ section.sort_order if section else '0' }}">
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-check mt-4">
          <input type="checkbox" class="form-check-input" id="is_active" name="is_active" value="1" {% if (section and section.is_active) or not section %}checked{% endif %}>
    const infoBarFields = document.getElementById('infoBarFields');
    
    // Hide all type-specific fields first
    heroFields.style.display = 'none';
    infoBarFields.style.display = 'none';
    
    // Show relevant fields based on type
    if (type === 'HERO') {
      heroFields.style.display = 'block';
    } else if (type === 'INFO_BAR') {
      infoBarFields.style.display = 'block

  <!-- Actions -->
  <div class="btn-group-custom">
    <button type="submit" class="btn btn-primary btn-lg">
      <i class="fas fa-save"></i> Save Section
    </button>
    <a href="/admin/pages/{{ page.id }}/sections" class="btn btn-secondary btn-lg">
      <i class="fas fa-arrow-left"></i> Back
    </a>
  </div>
</form>

<script>
  function updateTypeFields() {
    const type = document.getElementById('sectionType').value;
    const heroFields = document.getElementById('heroFields');
    
    if (type === 'HERO') {
      heroFields.style.display = 'block';
    } else {
      heroFields.style.display = 'none';
    }
  }
  
  function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
      // Check file size (max 15MB)
      if (file.size > 15 * 1024 * 1024) {
        alert('File is too large. Maximum size is 15MB.');
        event.target.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = '<div style="margin-top: 1rem;"><small class="text-muted">New image preview:</small><br><img src="' + e.target.result + '" alt="Preview" class="image-preview" style="max-width: 300px; margin-top: 0.5rem; border-radius: 0.5rem; border: 1px solid #e5e7eb;"></div>';
      };
      reader.readAsDataURL(file);
    }
  }
  
  function previewHeroImage(event) {
    const file = event.target.files[0];
    if (file) {
      // Check file size (max 15MB)
      if (file.size > 15 * 1024 * 1024) {
        alert('File is too large. Maximum size is 15MB.');
        event.target.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById('heroImagePreview');
        preview.innerHTML = '<div style="margin-top: 1rem;"><small class="text-muted">New image preview:</small><br><div style="position: relative; display: inline-block; margin-top: 0.5rem;"><img src="' + e.target.result + '" alt="Preview" class="image-preview" style="max-width: 300px; border-radius: 0.5rem; border: 1px solid #e5e7eb;"><button type="button" onclick="clearNewHeroImage()" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px; line-height: 1; box-shadow: 0 2px 4px rgba(0,0,0,0.2);" title="Remove"><i class="fas fa-times"></i></button></div></div>';
      };
      reader.readAsDataURL(file);
    }
  }
  
  function deleteCurrentHeroImage() {
    if (confirm('Are you sure you want to delete this image?')) {
      document.getElementById('currentHeroImage').style.display = 'none';
      document.getElementById('deleteHeroImage').value = '1';
      document.getElementById('heroImageInput').value = '';
    }
  }
  
  function clearNewHeroImage() {
    document.getElementById('heroImageInput').value = '';
    const currentImage = document.getElementById('currentHeroImage');
    if (currentImage) {
      document.getElementById('heroImagePreview').innerHTML = currentImage.outerHTML;
    } else {
      document.getElementById('heroImagePreview').innerHTML = '';
    }
  }
  
  // Initialize Rich Text Editor (Quill)
  let quill;
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    updateTypeFields();
    
    // Initialize Quill editor
    quill = new Quill('#section_description', {
      theme: 'snow',
      modules: {
        toolbar: [
          [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
          [{ 'font': [] }],
          [{ 'size': ['small', false, 'large', 'huge'] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'color': [] }, { 'background': [] }],
          [{ 'script': 'sub'}, { 'script': 'super' }],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          [{ 'indent': '-1'}, { 'indent': '+1' }],
          [{ 'align': [] }],
          ['link', 'image', 'video'],
          ['clean']
        ]
      },
      placeholder: 'Enter section description with formatting...'
    });
    
    // Set initial content if editing
    const descriptionTextarea = document.querySelector('textarea[name="section_description"]');
    if (descriptionTextarea && descriptionTextarea.value) {
      quill.root.innerHTML = descriptionTextarea.value;
    }
    
    // Update hidden textarea before form submission
    document.querySelector('form').addEventListener('submit', function() {
      descriptionTextarea.value = quill.root.innerHTML;
    });
  });
</script>

{% endblock %}

